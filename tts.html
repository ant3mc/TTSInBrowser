<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>TTS –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; height: 100vh; overflow: hidden; background: #fafafa; color: #333; }
    html:-webkit-full-screen, html:fullscreen { overflow: hidden; }
    .visually-hidden { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    .menu-item:focus, .speed-btn:focus, .font-btn:focus, .control-btn:focus, .menu-toggle:focus, .close-btn:focus,
    select:focus, input:focus, textarea:focus { outline: none !important; box-shadow: 0 0 0 3px #4CAF50, 0 0 0 6px rgba(76, 175, 80, 0.3) !important; }

    #startScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: flex; flex-direction: column; overflow: hidden; padding: 40px; padding-bottom: 0; }
    .start-title { text-align: center; font-size: 2.5em; margin-bottom: 40px; color: #333; flex-shrink: 0; }
    .start-menu { max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; padding-bottom: 40px; padding-top: 10px; }
    @media (orientation: landscape) and (min-width: 600px) { .start-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: none; } .menu-item { margin: 0; } }
    .menu-item { padding: 15px 20px; margin: 10px 0; border: 2px solid #4CAF50; border-radius: 8px; cursor: pointer; text-align: center; font-size: 1.2em; transition: all 0.3s; outline: none; background: white; }
    .menu-item:hover, .menu-item:focus { background: #4CAF50; color: white; }
    .hidden { display: none !important; }

    #mainInterface { height: 100vh; display: flex; flex-direction: column; }
    .control-row { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; flex-wrap: wrap; }
    .speed-control, .font-size-control { display: flex; align-items: center; background: white; border-radius: 6px; padding: 4px; border: 1px solid #ddd; }
    .speed-btn, .font-btn { background: none; border: none; padding: 6px 10px; cursor: pointer; font-size: 16px; outline: none; border-radius: 3px; }
    .speed-btn:hover, .font-btn:hover { background: #f0f0f0; }
    .speed-value, .font-value { padding: 0 12px; font-weight: bold; min-width: 50px; text-align: center; }
    .playback-control { display: flex; align-items: center; gap: 5px; }
    .control-btn { padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 14px; outline: none; min-width: 44px; }
    .control-btn:hover { background: #f9f9f9; }
    .play-btn { background: #4CAF50; color: white; border-color: #4CAF50; }
    .play-btn:hover { background: #45a049; }
    .menu-toggle { margin-left: auto; padding: 8px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; outline: none; }
    .menu-toggle:hover { background: #45a049; }
    .text-container { flex: 1; overflow: auto; padding: 20px; background: #fafafa; }
    #textContent { line-height: 1.6; color: #333; max-width: 100%; white-space: pre-wrap; word-wrap: break-word; min-height: 100%; }
    .current-fragment { background: #333 !important; color: white !important; padding: 2px 4px; border-radius: 3px; }
    #textInput { width: 100%; height: 100%; border: none; outline: none; line-height: 1.6; padding: 20px; background: #fafafa; resize: none; font-family: Arial, sans-serif; color: #333; }
    .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1001; max-width: none; width: 90%; }
    .modal h2 { margin-bottom: 20px; text-align: center; }
    .modal-content { max-height: 400px; overflow-y: auto; margin-bottom: 20px; width: 100%; box-sizing: border-box; }
    .close-btn, .action-btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; display: block; margin: 0 auto; outline: none; }
    .close-btn { background: #4CAF50; color: white; } .close-btn:hover { background: #45a049; }
    .action-btn--danger { background: #d32f2f; color: white; margin-top: 10px; } .action-btn--danger:hover { background: #b71c1c; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .status { margin: 10px 0 0 0; padding: 10px; border-radius: 4px; background: #e8f5e8; width: 100%; box-sizing: border-box; }
    .status.error { background: #ffebee; color: #d32f2f; } .status.warning { background: #fff3e0; color: #e65100; }
    select, input[type="number"], input[type="range"] { outline: none; width: 100%; padding: 10px; margin-bottom: 20px; }
    select:focus, input:focus, input[type="range"]:focus { box-shadow: 0 0 0 2px rgba(76,175,80,0.3); }

    #settingsScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1002; display: flex; flex-direction: column; overflow: hidden; padding: 40px; }
    html[data-theme="dark"] #settingsScreen { background: #2a2a2a; }

    @media (prefers-color-scheme: dark) {
      body, #textInput, .text-container { background: #1e1e1e; color: #e0e0e0; }
      #startScreen, .modal, .control-row { background: #2a2a2a; }
      .start-title { color: #f0f0f0; } .menu-item { background: #2a2a2a; color: #e0e0e0; border-color: #4CAF50; }
      .speed-control, .font-size-control { background: #1e1e1e; border-color: #444; }
      .control-btn { background: #2a2a2a; color: #e0e0e0; border-color: #444; }
      .status.error { background: #3e2723; color: #ff8a80; } .status.warning { background: #3e2f0b; color: #ffb74d; }
      .status:not(.error):not(.warning) { background: #1b5e20; color: #a5d6a7; }
      .current-fragment { background: #FFD700 !important; color: #000 !important; font-weight: bold; }
    }

    html[data-theme="dark"] body, html[data-theme="dark"] #textInput, html[data-theme="dark"] .text-container { background: #1e1e1e; color: #e0e0e0; }
    html[data-theme="dark"] #startScreen, html[data-theme="dark"] .modal, html[data-theme="dark"] .control-row { background: #2a2a2a; }
    html[data-theme="dark"] .start-title { color: #f0f0f0; }
    html[data-theme="dark"] .menu-item { background: #2a2a2a; color: #e0e0e0; border-color: #4CAF50; }
    html[data-theme="dark"] .current-fragment { background: #FFD700 !important; color: #000 !important; font-weight: bold; }
  </style>
</head>
<body>
  <div id="startScreen">
    <h1 class="start-title">TTS –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞</h1>
    <div class="start-menu">
      <div id="resumeText" class="menu-item hidden" tabindex="0">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ–∫—Å—Ç—É</div>
      <div id="menuInfo" class="menu-item" tabindex="0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
      <div id="menuVoice" class="menu-item" tabindex="0">–í—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞</div>
      <div id="menuOpenFile" class="menu-item" tabindex="0">–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª</div>
      <div id="menuTextInput" class="menu-item" tabindex="0">–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞</div>
      <div id="menuLoadDict" class="menu-item" tabindex="0">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å –∑–∞–º–µ–Ω</div>
      <div id="menuSavePosition" class="menu-item" tabindex="0">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</div>
      <div id="menuSettings" class="menu-item" tabindex="0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div id="menuExit" class="menu-item" tabindex="0">–í—ã—Ö–æ–¥</div>
    </div>
  </div>

  <div id="mainInterface" class="hidden">
    <div class="control-row">
      <div class="speed-control">
        <button class="speed-btn" id="speedDown" title="–£–º–µ–Ω—å—à–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å" tabindex="0" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏">üîâ</button>
        <span class="speed-value" id="speedValue" aria-live="polite">1.00x</span>
        <button class="speed-btn" id="speedUp" title="–£–≤–µ–ª–∏—á–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å" tabindex="0" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏">üîä</button>
      </div>
      <div class="font-size-control">
        <button class="font-btn control-btn" id="fontSmaller" title="–£–º–µ–Ω—å—à–∏—Ç—å —à—Ä–∏—Ñ—Ç" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å —à—Ä–∏—Ñ—Ç">A‚àí</button>
        <span class="font-value" id="fontValue">32px</span>
        <button class="font-btn control-btn" id="fontLarger" title="–£–≤–µ–ª–∏—á–∏—Ç—å —à—Ä–∏—Ñ—Ç" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å —à—Ä–∏—Ñ—Ç">A+</button>
      </div>
      <div class="playback-control">
        <button class="control-btn" id="prevFragment" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç" tabindex="0" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç">‚è™</button>
        <button class="control-btn play-btn" id="playPause" title="–ü—É—Å–∫/–ü–∞—É–∑–∞" tabindex="0" aria-label="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞">‚ñ∂</button>
        <button class="control-btn" id="nextFragment" title="–°–ª–µ–¥—É—é—â–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç" tabindex="0" aria-label="–°–ª–µ–¥—É—é—â–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç">‚è©</button>
      </div>
      <button class="menu-toggle" id="menuToggle" title="–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é" tabindex="0" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">‚ò∞</button>
    </div>
    <div class="text-container">
      <div id="textContent" class="hidden" tabindex="0" title="–ü—Ä–æ–±–µ–ª: –ø—É—Å–∫/–ø–∞—É–∑–∞" aria-label="–¢–µ–∫—Å—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è. –ù–∞–∂–º–∏—Ç–µ –ø—Ä–æ–±–µ–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–ª–∏ –ø–∞—É–∑—ã."></div>
      <textarea id="textInput" class="hidden" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è..." tabindex="0"></textarea>
    </div>
    <div id="status" class="status hidden" aria-live="polite"></div>
  </div>

  <div id="settingsScreen" class="hidden">
    <h2 class="start-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
    <div class="start-menu" style="max-width: 600px;">
      <label for="minFragmentLength" style="text-align: left; padding: 15px; border: 2px solid #4CAF50; border-radius: 8px;">
        –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ (–æ—Ç 10 –¥–æ 990, —à–∞–≥ 10):
        <input type="number" id="minFragmentLength" min="10" max="990" step="10" style="width: 100%; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;">
      </label>
      
      <label for="mainFragmentLength" style="text-align: left; padding: 15px; border: 2px solid #4CAF50; border-radius: 8px;">
        –î–ª–∏–Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ (–æ—Ç 10 –¥–æ 990, —à–∞–≥ 10):
        <input type="number" id="mainFragmentLength" min="10" max="990" step="10" style="width: 100%; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;">
      </label>
      
      <label for="volumeSlider" style="text-align: left; padding: 15px; border: 2px solid #4CAF50; border-radius: 8px;">
        –ì—Ä–æ–º–∫–æ—Å—Ç—å –æ–∑–≤—É—á–∫–∏:
        <input type="range" id="volumeSlider" min="0.3" max="1.0" step="0.1" style="width: 100%; margin-top: 10px;">
        <span id="volumeValue" style="display: block; text-align: center; margin-top: 5px;"></span>
      </label>
      
      <!-- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ –¥–ª—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ -->
      <label for="currentFragmentNumber" style="text-align: left; padding: 15px; border: 2px solid #4CAF50; border-radius: 8px;">
        –ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞:
        <input type="number" id="currentFragmentNumber" min="1" style="width: 100%; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;">
        <small style="display: block; margin-top: 5px; color: #666;" id="fragmentRangeInfo">–î–æ—Å—Ç—É–ø–Ω–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤: 0</small>
      </label>
      
      <label for="themeSelect" style="text-align: left; padding: 15px; border: 2px solid #4CAF50; border-radius:8px;">
        –¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:
        <select id="themeSelect" style="width: 100%; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="auto">–°–∏—Å—Ç–µ–º–Ω–∞—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
          <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
          <option value="dark">–¢—ë–º–Ω–∞—è</option>
        </select>
      </label>
    </div>
    <div style="display: flex; gap: 10px; justify-content: center; margin-top: auto; padding-top: 20px;">
      <button class="menu-item" id="applySettingsBtn" tabindex="0">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button class="menu-item" id="cancelSettingsBtn" tabindex="0">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <div id="infoModal" class="modal hidden">
    <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
    <div class="modal-content">
      <p>–ü—Ä–æ–≥—Ä–∞–º–º–∞ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ Chrome.</p>
      <p>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—ã: TXT, HTML</p>
      <p>–§—É–Ω–∫—Ü–∏–∏:</p>
      <ul>
        <li>–†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏</li>
        <li>–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞–º</li>
        <li>–ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞</li>
        <li>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è –∑–∞–º–µ–Ω</li>
        <li>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã</li>
        <li>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 20 —Ñ–∞–π–ª–æ–≤</li>
      </ul>
      <p><strong>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</strong></p>
      <ul>
        <li>–ü—Ä–æ–±–µ–ª: –ü—É—Å–∫/–ü–∞—É–∑–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö –∏ –æ—Å–Ω–æ–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ, –Ω–æ –Ω–µ –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞)</li>
        <li><strong>Alt+K</strong>, <strong>Alt+–õ</strong>, <strong>K</strong>, <strong>–õ</strong>: –ü—É—Å–∫/–ü–∞—É–∑–∞ (—Ä–∞–±–æ—Ç–∞—é—Ç –≤–µ–∑–¥–µ)</li>
        <li>‚Üê/‚Üí: –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞–º</li>
        <li><strong>Alt+‚Üê / Alt+‚Üí</strong>: –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞–º (–≥–ª–æ–±–∞–ª—å–Ω–æ)</li>
        <li>‚Üë/‚Üì: –°–∫–æ—Ä–æ—Å—Ç—å (–ª–æ–∫–∞–ª—å–Ω–æ)</li>
        <li><strong>Alt+‚Üë / Alt+‚Üì</strong>: –°–∫–æ—Ä–æ—Å—Ç—å (–≥–ª–æ–±–∞–ª—å–Ω–æ)</li>
        <li>j / l: –ì—Ä–æ–º–∫–æ—Å—Ç—å (j ‚Äî —Ç–∏—à–µ, l ‚Äî –≥—Ä–æ–º—á–µ)</li>
        <li>–æ / –¥: –ì—Ä–æ–º–∫–æ—Å—Ç—å (–æ ‚Äî —Ç–∏—à–µ, –¥ ‚Äî –≥—Ä–æ–º—á–µ)</li>
        <li><strong>Alt+S</strong>: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–∞–π–ª–æ–≤)</li>
        <li><strong>Alt+B</strong>: –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–∑–≤—É—á–∫–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ)</li>
        <li><strong>Alt++ / Alt+-</strong>: –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</li>
        <li><strong>Alt+F / Alt+–ê</strong>: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞</li>
        <li>Tab: –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º</li>
        <li>Escape: –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</li>
      </ul>
    </div>
    <button class="close-btn" data-modal="infoModal" tabindex="0">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <div id="voiceModal" class="modal hidden">
    <h2>–í—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞</h2>
    <div class="modal-content">
      <select id="voiceSelect" aria-label="–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–ª–æ—Å"></select>
      <div id="voiceInfo"></div>
    </div>
    <button class="close-btn" data-modal="voiceModal" tabindex="0">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  </div>

  <div id="dictModal" class="modal hidden">
    <h2>–°–ª–æ–≤–∞—Ä—å –∑–∞–º–µ–Ω</h2>
    <div class="modal-content">
      <p>–§–æ—Ä–º–∞—Ç: <code>–∫–ª—é—á=–∑–Ω–∞—á–µ–Ω–∏–µ</code> –∏–ª–∏ <code>'–∫–ª—é—á'='–∑–Ω–∞—á–µ–Ω–∏–µ'</code></p>
      <div id="dictStatus" class="status"></div>
      <p id="dictInfo"></p>
      <div id="dictErrors"></div>
    </div>
    <button class="action-btn action-btn--danger" data-action="clearDictionary" tabindex="0">–û—á–∏—Å—Ç–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å</button>
    <button class="close-btn" data-modal="dictModal" tabindex="0">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <input type="file" id="fileInput" accept=".txt,.html,.htm" class="visually-hidden">
  <input type="file" id="dictInput" accept=".txt" class="visually-hidden">
  
  <script>
    // ==================== –£–ü–†–û–©–Å–ù–ù–´–ô STORAGE MANAGER ====================
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ localStorage, —Ç–∞–∫ –∫–∞–∫ cookies –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ file://
    const Storage = {
      set(key, value) {
        try {
          localStorage.setItem('tts_' + key, JSON.stringify(value));
          return true;
        } catch (e) {
          console.error('Storage: –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', e);
          return false;
        }
      },
      
      get(key, defaultValue) {
        try {
          const item = localStorage.getItem('tts_' + key);
          if (item) {
            const parsed = JSON.parse(item);
            return parsed;
          }
        } catch (e) {
          console.error('Storage: –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', e);
        }
        return defaultValue;
      }
    };

    function saveAllSettings() {
      const settings = {
        voice: selectedVoiceIndex,
        fragment: minFragmentLength,
        mainFragment: mainFragmentLength,
        theme: themeSelect.value
      };
      
      Storage.set('settings', settings);
      updateStatus('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'info');
    }

    function loadAllSettings() {
      const s = Storage.get('settings', {});
      
      if (s.voice !== undefined) selectedVoiceIndex = s.voice;
      if (s.fragment !== undefined) {
        minFragmentLength = s.fragment;
        document.getElementById('minFragmentLength').value = s.fragment;
      }
      if (s.mainFragment !== undefined) {
        mainFragmentLength = s.mainFragment;
        document.getElementById('mainFragmentLength').value = s.mainFragment;
      }
      if (s.theme !== undefined) {
        themeSelect.value = s.theme;
        document.documentElement.setAttribute('data-theme', s.theme);
      }
      
      volumeSlider.value = currentVolume;
      volumeValue.textContent = Math.round(currentVolume * 100) + '%';
      updateTextFontSize();
      
      updateStatus('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'info');
    }
    // ==================== –ö–û–ù–ï–¶ STORAGE MANAGER ====================

    // ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–û–ó–ò–¶–ò–ò –û–ó–í–£–ß–ö–ò ====================
    const POSITION_HISTORY_KEY = 'tts_position_history';
    const MAX_HISTORY_ENTRIES = 20;

    function getFileHash(filename) {
      let hash = 0;
      for (let i = 0; i < filename.length; i++) {
        hash = ((hash << 5) - hash) + filename.charCodeAt(i);
        hash = hash & hash;
      }
      return hash.toString(36);
    }

    function saveCurrentPosition() {
      if (currentMode !== 'file') return false;
      
      const fileInput = document.getElementById('fileInput');
      if (!fileInput.files || !fileInput.files[0]) return false;
      
      const fileName = fileInput.files[0].name;
      const fileHash = getFileHash(fileName);
      const positionData = {
        hash: fileHash,
        fileName: fileName,
        fragmentIndex: currentFragmentIndex,
        timestamp: Date.now(),
        fragmentCount: fragments.length
      };
      
      const history = Storage.get(POSITION_HISTORY_KEY, []);
      const filteredHistory = history.filter(entry => entry.hash !== fileHash);
      filteredHistory.unshift(positionData);
      const trimmedHistory = filteredHistory.slice(0, MAX_HISTORY_ENTRIES);
      
      return Storage.set(POSITION_HISTORY_KEY, trimmedHistory);
    }

    function loadPositionForFile(filename) {
      if (!filename) return 0;
      
      const fileHash = getFileHash(filename);
      const history = Storage.get(POSITION_HISTORY_KEY, []);
      
      const entry = history.find(entry => entry.hash === fileHash);
      if (entry) {
        if (entry.fragmentIndex >= 0 && entry.fragmentIndex < entry.fragmentCount) {
          return entry.fragmentIndex;
        }
      }
      
      return 0;
    }

    // –†—É—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
    function savePositionManually() {
      if (currentMode !== 'file') {
        updateStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–∞–π–ª–æ–≤', 'warning');
        return;
      }
      
      if (fragments.length === 0) {
        updateStatus('–ù–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏', 'warning');
        return;
      }
      
      const saved = saveCurrentPosition();
      if (saved) {
        updateStatus(`–ü–æ–∑–∏—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: —Ñ—Ä–∞–≥–º–µ–Ω—Ç ${currentFragmentIndex + 1} –∏–∑ ${fragments.length}`, 'info');
      } else {
        updateStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é', 'error');
      }
    }
    // ==================== –ö–û–ù–ï–¶ –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–û–ó–ò–¶–ò–ò ====================

    const CONFIG = {
      MIN_SPEED: 0.25,
      MAX_SPEED: 1.0,
      SPEED_STEP: 0.05,
      MIN_VOLUME: 0.3,
      MAX_VOLUME: 1.0,
      VOLUME_STEP: 0.1,
      MIN_FONT_SIZE: 16,
      MAX_FONT_SIZE: 96,
      FONT_STEP: 8,
      DEFAULT_MIN_FRAGMENT_LENGTH: 20,
      DEFAULT_MAIN_FRAGMENT_LENGTH: 150,
      STATUS_TIMEOUT: 5000
    };

    const synth = window.speechSynthesis;
    const modalLastFocused = new WeakMap();
    let voices = [];
    let currentSpeed = 1.0;
    let currentVolume = 1.0;
    let currentFontSize = 32;
    let currentFragmentIndex = 0;
    let rawText = '';
    let fragments = [];
    let currentUtterance = null;
    let isPlaying = false;
    let selectedVoiceIndex = null;
    let currentMode = '';
    let replacementDict = new Map();
    let replacementDictSortedKeys = [];
    let minFragmentLength = CONFIG.DEFAULT_MIN_FRAGMENT_LENGTH;
    let mainFragmentLength = CONFIG.DEFAULT_MAIN_FRAGMENT_LENGTH;
    let statusClearTimeout = null;

    const startScreen = document.getElementById('startScreen');
    const mainInterface = document.getElementById('mainInterface');
    const textContent = document.getElementById('textContent');
    const textInput = document.getElementById('textInput');
    const voiceSelect = document.getElementById('voiceSelect');
    const playPauseBtn = document.getElementById('playPause');
    const prevFragmentBtn = document.getElementById('prevFragment');
    const nextFragmentBtn = document.getElementById('nextFragment');
    const speedDownBtn = document.getElementById('speedDown');
    const speedUpBtn = document.getElementById('speedUp');
    const speedValue = document.getElementById('speedValue');
    const statusContainer = document.getElementById('status');
    const voiceInfo = document.getElementById('voiceInfo');
    const dictStatus = document.getElementById('dictStatus');
    const dictInfo = document.getElementById('dictInfo');
    const dictErrors = document.getElementById('dictErrors');
    const menuToggleBtn = document.getElementById('menuToggle');
    const resumeTextBtn = document.getElementById('resumeText');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeValue = document.getElementById('volumeValue');
    const themeSelect = document.getElementById('themeSelect');
    const settingsScreen = document.getElementById('settingsScreen');
    const mainFragmentLengthInput = document.getElementById('mainFragmentLength');
    const currentFragmentNumberInput = document.getElementById('currentFragmentNumber');
    const fragmentRangeInfo = document.getElementById('fragmentRangeInfo');

    function initAccessibility() {
      document.getElementById('speedDown').setAttribute('aria-label', '–£–º–µ–Ω—å—à–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏');
      document.getElementById('speedUp').setAttribute('aria-label', '–£–≤–µ–ª–∏—á–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏');
      document.getElementById('fontSmaller').setAttribute('aria-label', '–£–º–µ–Ω—å—à–∏—Ç—å —à—Ä–∏—Ñ—Ç');
      document.getElementById('fontLarger').setAttribute('aria-label', '–£–≤–µ–ª–∏—á–∏—Ç—å —à—Ä–∏—Ñ—Ç');
      document.getElementById('playPause').setAttribute('aria-label', '–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞');
      document.getElementById('prevFragment').setAttribute('aria-label', '–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç');
      document.getElementById('nextFragment').setAttribute('aria-label', '–°–ª–µ–¥—É—é—â–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç');
      document.getElementById('menuToggle').setAttribute('aria-label', '–û—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é');
      statusContainer.setAttribute('aria-live', 'polite');
      document.querySelectorAll('.modal').forEach(setupModalAccessibility);
    }

    function setupModalAccessibility(modal) {
      modal.setAttribute('role', 'dialog');
      modal.setAttribute('aria-modal', 'true');
      modal.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          const focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
          if (focusable.length === 0) return;
          const first = focusable[0];
          const last = focusable[focusable.length - 1];
          if (e.shiftKey) {
            if (document.activeElement === first) {
              e.preventDefault();
              last.focus();
            }
          } else {
            if (document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          }
        }
      });
    }

    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('hidden');
      modalLastFocused.set(modal, document.activeElement);
      const overlay = createOverlay();
      document.body.appendChild(overlay);
      const firstFocusable = modal.querySelector('button, input, select') || modal.querySelector('.close-btn');
      if (firstFocusable) firstFocusable.focus();
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.add('hidden');
      const overlay = document.querySelector('.overlay');
      if (overlay) overlay.remove();
      const lastFocused = modalLastFocused.get(modal);
      if (lastFocused && typeof lastFocused.focus === 'function') {
        lastFocused.focus();
      }
      modalLastFocused.delete(modal);
    }

    function updateTextFontSize() {
      const size = currentFontSize + 'px';
      textContent.style.fontSize = size;
      textInput.style.fontSize = size;
      document.getElementById('fontValue').textContent = size;
    }

    document.getElementById('fontSmaller').addEventListener('click', () => {
      if (currentFontSize > CONFIG.MIN_FONT_SIZE) {
        currentFontSize -= CONFIG.FONT_STEP;
        updateTextFontSize();
        updateStatus(`–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞: ${currentFontSize} –ø–∏–∫—Å–µ–ª–µ–π`, 'info');
      }
    });

    document.getElementById('fontLarger').addEventListener('click', () => {
      if (currentFontSize < CONFIG.MAX_FONT_SIZE) {
        currentFontSize += CONFIG.FONT_STEP;
        updateTextFontSize();
        updateStatus(`–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞: ${currentFontSize} –ø–∏–∫—Å–µ–ª–µ–π`, 'info');
      }
    });

    updateTextFontSize();

    function handleMenuKeypress(event, callback) {
      if (event.key === ' ' || event.key === 'Enter') {
        event.preventDefault();
        callback();
      }
    }

    function extractTextFromHtml(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const unsafeTags = ['script', 'style', 'noscript', 'iframe', 'object', 'embed'];
      unsafeTags.forEach(tag => {
        doc.querySelectorAll(tag).forEach(el => el.remove());
      });
      const walker = document.createTreeWalker(
        doc.body || doc.documentElement,
        NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT,
        {
          acceptNode(node) {
            if (node.nodeType === Node.TEXT_NODE) {
              return NodeFilter.FILTER_ACCEPT;
            }
            if (node.nodeType === Node.ELEMENT_NODE) {
              const tag = node.tagName.toLowerCase();
              if (/^(h[1-6]|p|div|section|article|header|footer|aside|nav|ul|ol|li|blockquote|pre|figure|table|tr|td|th|dl|dt|dd|address|main)$/i.test(tag)) {
                return NodeFilter.FILTER_ACCEPT;
              }
              return NodeFilter.FILTER_SKIP;
            }
            return NodeFilter.FILTER_REJECT;
          }
        }
      );
      const lines = [];
      let buffer = '';
      function flush() {
        if (buffer.trim()) {
          lines.push(buffer);
          buffer = '';
        } else if (lines.length > 0 && lines[lines.length - 1] !== '') {
          lines.push('');
        }
      }
      let node;
      while (node = walker.nextNode()) {
        if (node.nodeType === Node.TEXT_NODE) {
          buffer += node.textContent;
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          const tag = node.tagName.toLowerCase();
          if (tag === 'br') {
            flush();
          } else if (/^(li|td|th)$/i.test(tag)) {
            buffer += '\t';
          } else if (/^(h[1-6]|p|div|section|article|header|footer|aside|nav|blockquote|pre|figure|table|ul|ol|dl)$/i.test(tag)) {
            flush();
            if (lines.length === 0 || lines[lines.length - 1] !== '') {
              lines.push('');
            }
          }
        }
      }
      flush();
      let result = lines.join('\n');
      result = result.replace(/\n{3,}/g, '\n').trim();
      return result;
    }

    function toggleFullscreen() {
      const controls = document.querySelector('.control-row');
      const status = document.getElementById('status');
      const isHidden = controls.classList.contains('hidden');
      
      if (isHidden) {
        controls.classList.remove('hidden');
        status.classList.remove('hidden');
        updateStatus('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω', 'info');
      } else {
        controls.classList.add('hidden');
        status.classList.add('hidden');
        updateStatus('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω (ESC –¥–ª—è –≤—ã—Ö–æ–¥–∞)', 'info');
      }
    }

    document.addEventListener('keydown', function(event) {
      if ((event.target.tagName === 'TEXTAREA' || event.target.tagName === 'INPUT') && !event.altKey) {
        return;
      }
      
      const openModal = document.querySelector('.modal:not(.hidden)');
      if (openModal) {
        if (event.key === 'Escape') {
          event.preventDefault();
          closeModal(openModal.id);
          return;
        }
      }
      
      if (event.key === 'Escape' && !settingsScreen.classList.contains('hidden')) {
        event.preventDefault();
        hideSettings();
        return;
      }
      
      if (event.key === 'Escape') {
        const controls = document.querySelector('.control-row');
        if (controls.classList.contains('hidden') && mainInterface.classList.contains('hidden') === false) {
          event.preventDefault();
          controls.classList.remove('hidden');
          document.getElementById('status').classList.remove('hidden');
          updateStatus('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω', 'info');
          return;
        }
      }
      
      if (event.altKey) {
        const key = event.key.toLowerCase();
        
        switch(key) {
          case 'f': case '–∞':
            event.preventDefault();
            toggleFullscreen();
            return;
          case 'k': case '–ª':
            event.preventDefault();
            playPauseBtn.click();
            return;
          case 'arrowleft':
            event.preventDefault();
            prevFragmentBtn.click();
            return;
          case 'arrowright':
            event.preventDefault();
            nextFragmentBtn.click();
            return;
          case 's': case '—ã':
            if (currentMode === 'file') {
              event.preventDefault();
              savePositionManually();
            }
            return;
          case 'b': case '–∏':
            event.preventDefault();
            synth.cancel();
            isPlaying = false;
            playPauseBtn.textContent = '‚ñ∂';
            updateStatus('–û–∑–≤—É—á–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞', 'info');
            return;
          case '+': case '=':
            event.preventDefault();
            if (currentFontSize < CONFIG.MAX_FONT_SIZE) {
              currentFontSize += CONFIG.FONT_STEP;
              updateTextFontSize();
              updateStatus(`–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞: ${currentFontSize} –ø–∏–∫—Å–µ–ª–µ–π`, 'info');
            }
            return;
          case '-':
            event.preventDefault();
            if (currentFontSize > CONFIG.MIN_FONT_SIZE) {
              currentFontSize -= CONFIG.FONT_STEP;
              updateTextFontSize();
              updateStatus(`–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞: ${currentFontSize} –ø–∏–∫—Å–µ–ª–µ–π`, 'info');
            }
            return;
          case 'arrowup':
            event.preventDefault();
            if (currentSpeed < CONFIG.MAX_SPEED) {
              currentSpeed = Math.min(CONFIG.MAX_SPEED, currentSpeed + CONFIG.SPEED_STEP);
              updateSpeed();
              updateStatus(`–°–∫–æ—Ä–æ—Å—Ç—å: ${currentSpeed.toFixed(2)}x`, 'info');
            }
            return;
          case 'arrowdown':
            event.preventDefault();
            if (currentSpeed > CONFIG.MIN_SPEED) {
              currentSpeed = Math.max(CONFIG.MIN_SPEED, currentSpeed - CONFIG.SPEED_STEP);
              updateSpeed();
              updateStatus(`–°–∫–æ—Ä–æ—Å—Ç—å: ${currentSpeed.toFixed(2)}x`, 'info');
            }
            return;
        }
      }
      
      if (!startScreen.classList.contains('hidden')) {
        return;
      }
      
      if (event.target.tagName === 'TEXTAREA' || event.target.tagName === 'INPUT') {
        return;
      }
      
      switch(event.key) {
        case 'k': case 'K': case '–ª': case '–õ':
          event.preventDefault();
          playPauseBtn.click();
          return;
        case ' ':
          if (event.target === textContent) {
            event.preventDefault();
            playPauseBtn.click();
          }
          return;
        case 'Escape':
          event.preventDefault();
          const anyModal = document.querySelector('.modal:not(.hidden)');
          if (anyModal) {
            closeModal(anyModal.id);
          } else {
            showStartScreen();
          }
          return;
        case 'ArrowLeft':
          event.preventDefault();
          prevFragmentBtn.click();
          return;
        case 'ArrowRight':
          event.preventDefault();
          nextFragmentBtn.click();
          return;
        case 'ArrowDown':
          event.preventDefault();
          speedDownBtn.click();
          return;
        case 'ArrowUp':
          event.preventDefault();
          speedUpBtn.click();
          return;
        case 'j': case 'J': case '–æ': case '–û':
          event.preventDefault();
          if (currentVolume > CONFIG.MIN_VOLUME) {
            currentVolume = Math.max(CONFIG.MIN_VOLUME, currentVolume - CONFIG.VOLUME_STEP);
            updateStatus(`–ì—Ä–æ–º–∫–æ—Å—Ç—å: ${Math.round(currentVolume * 100)}%`, 'info');
            volumeSlider.value = currentVolume;
            volumeValue.textContent = Math.round(currentVolume * 100) + '%';
          }
          return;
        case 'l': case 'L': case '–¥': case '–î':
          event.preventDefault();
          if (currentVolume < CONFIG.MAX_VOLUME) {
            currentVolume = Math.min(CONFIG.MAX_VOLUME, currentVolume + CONFIG.VOLUME_STEP);
            updateStatus(`–ì—Ä–æ–º–∫–æ—Å—Ç—å: ${Math.round(currentVolume * 100)}%`, 'info');
            volumeSlider.value = currentVolume;
            volumeValue.textContent = Math.round(currentVolume * 100) + '%';
          }
          return;
      }
    });

    function showInfo() {
      openModal('infoModal');
    }

    function showVoiceSelect() {
      loadVoicesForModal();
      if (voices.length === 0) {
        const warmup = new SpeechSynthesisUtterance('');
        warmup.volume = 0;
        synth.speak(warmup);
        synth.cancel();
        setTimeout(() => {
          loadVoicesForModal();
          if (voices.length === 0) setTimeout(loadVoicesForModal, 500);
        }, 300);
      }
      openModal('voiceModal');
    }

    function openFile() { document.getElementById('fileInput').click(); }

    function startTextInput() {
      startScreen.classList.add('hidden');
      mainInterface.classList.remove('hidden');
      textInput.classList.remove('hidden');
      textContent.classList.add('hidden');
      currentMode = 'text';
      rawText = '';
      fragments = [];
      updateStatus('–†–µ–∂–∏–º –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞. –í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç.');
      setTimeout(() => textInput.focus(), 100);
    }

    function loadDictionary() { document.getElementById('dictInput').click(); }

    function closeApp() {
      if (confirm('–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?')) window.close();
    }

    function createOverlay() {
      const overlay = document.createElement('div');
      overlay.className = 'overlay';
      overlay.onclick = function() {
        document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
        overlay.remove();
      };
      return overlay;
    }

    function showStartScreen() {
      if (isPlaying) {
        synth.cancel();
        isPlaying = false;
        playPauseBtn.textContent = '‚ñ∂';
        updateStatus('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'info');
      }
      
      mainInterface.classList.add('hidden');
      settingsScreen.classList.add('hidden');
      startScreen.classList.remove('hidden');
      updateResumeTextVisibility();
      setTimeout(() => {
        if (!resumeTextBtn.classList.contains('hidden')) {
          resumeTextBtn.focus();
        } else {
          const firstVisibleMenuItem = document.querySelector('.menu-item:not(.hidden)');
          if (firstVisibleMenuItem) firstVisibleMenuItem.focus();
        }
      }, 100);
    }

    function updateResumeTextVisibility() {
      if (currentMode) {
        resumeTextBtn.classList.remove('hidden');
      } else {
        resumeTextBtn.classList.add('hidden');
      }
    }

    function resumeText() {
      startScreen.classList.add('hidden');
      mainInterface.classList.remove('hidden');
      if (currentMode === 'file') {
        textContent.classList.remove('hidden');
        textInput.classList.add('hidden');
        updateTextDisplay();
      } else if (currentMode === 'text') {
        textInput.classList.remove('hidden');
        textContent.classList.add('hidden');
        setTimeout(() => textInput.focus(), 100);
      }
      updateStatus('–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∫ —Ç–µ–∫—Å—Ç—É');
    }

    function escapeRegExp(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function applyReplacements(text) {
      if (replacementDict.size === 0) return text;
      const pattern = replacementDictSortedKeys.map(k => escapeRegExp(k)).join('|');
      const regex = new RegExp(pattern, 'g');
      return text.replace(regex, (match) => replacementDict.get(match));
    }

    function clearDictionary() {
      replacementDict = new Map();
      replacementDictSortedKeys = [];
      dictInfo.textContent = '–°–ª–æ–≤–∞—Ä—å –æ—á–∏—â–µ–Ω.';
      dictErrors.textContent = '';
      dictStatus.className = 'status';
      dictStatus.textContent = '';
      updateStatus('–°–ª–æ–≤–∞—Ä—å –∑–∞–º–µ–Ω –æ—á–∏—â–µ–Ω', 'info');
    }

    function handleDictFile(file) {
      if (!file) return;
      openModal('dictModal');
      const reader = new FileReader();
      reader.onload = function(e) {
        let totalLines = 0;
        let validEntries = 0;
        let errors = [];
        const newDict = new Map();
        try {
          const content = e.target.result;
          const lines = content.split(/\r?\n/);
          totalLines = lines.length;
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const eqIndex = line.indexOf('=');
            if (eqIndex === -1) {
              errors.push(`–°—Ç—Ä–æ–∫–∞ ${i + 1}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–∏–º–≤–æ–ª —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞`);
              continue;
            }
            let left = line.substring(0, eqIndex).trim();
            let right = line.substring(eqIndex + 1).replace(/\r$/, '');
            if ((left.startsWith('"') && left.endsWith('"')) ||
                (left.startsWith("'") && left.endsWith("'"))) {
              left = left.slice(1, -1);
            }
            if ((right.startsWith('"') && right.endsWith('"')) ||
                (right.startsWith("'") && right.endsWith("'"))) {
              right = right.slice(1, -1);
            }
            if (!left) {
              errors.push(`–°—Ç—Ä–æ–∫–∞ ${i + 1}: –ø—É—Å—Ç–æ–π –∫–ª—é—á`);
              continue;
            }
            newDict.set(left, right);
            validEntries++;
          }
          replacementDict = newDict;
          replacementDictSortedKeys = Array.from(newDict.keys()).sort((a, b) => b.length - a.length);
          dictInfo.textContent = '';
          const fileInfoLine = document.createElement('div');
          fileInfoLine.textContent = '–§–∞–π–ª: ';
          const fileNameSpan = document.createElement('strong');
          fileNameSpan.textContent = file.name || '–±–µ–∑ –∏–º–µ–Ω–∏';
          fileInfoLine.appendChild(fileNameSpan);
          dictInfo.appendChild(fileInfoLine);
          const statsLine = document.createElement('div');
          statsLine.textContent = `–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: ${totalLines} –í–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: ${validEntries}`;
          dictInfo.appendChild(statsLine);
          if (validEntries === 0 && totalLines > 0) {
            const warningSpan = document.createElement('span');
            warningSpan.style.color = '#e65100';
            warningSpan.textContent = ' –ù–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π!';
            statsLine.appendChild(warningSpan);
          }
          dictErrors.textContent = '';
          if (errors.length > 0) {
            dictStatus.textContent = '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏:';
            dictStatus.className = 'status warning';
            const errorList = document.createElement('ul');
            errorList.style.color = '#d32f2f';
            errorList.style.fontSize = '0.9em';
            errorList.style.marginTop = '8px';
            errors.slice(0, 20).forEach(err => {
              const li = document.createElement('li');
              li.textContent = err;
              errorList.appendChild(li);
            });
            if (errors.length > 20) {
              const li = document.createElement('li');
              li.textContent = `... –∏ –µ—â—ë ${errors.length - 20} –æ—à–∏–±–æ–∫`;
              errorList.appendChild(li);
            }
            dictErrors.appendChild(errorList);
          } else {
            dictStatus.className = 'status';
            dictStatus.textContent = '–°–ª–æ–≤–∞—Ä—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω';
          }
          const globalMsg = `–°–ª–æ–≤–∞—Ä—å "${file.name}" –∑–∞–≥—Ä—É–∂–µ–Ω (${validEntries} –∑–∞–ø–∏—Å–µ–π)` +
            (errors.length ? `. –û—à–∏–±–æ–∫: ${errors.length}.` : '.');
          updateStatus(globalMsg, errors.length ? 'warning' : 'info');
          const clearStatus = () => {
            if (statusContainer.textContent.startsWith('–°–ª–æ–≤–∞—Ä—å')) {
              statusContainer.textContent = '';
              statusContainer.className = 'status';
              statusContainer.classList.add('hidden');
            }
          };
          statusClearTimeout = setTimeout(clearStatus, CONFIG.STATUS_TIMEOUT);
        } catch (err) {
          dictInfo.textContent = '';
          const errorLine = document.createElement('div');
          errorLine.textContent = '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: ' + (err.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
          dictInfo.appendChild(errorLine);
          dictStatus.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ª–æ–≤–∞—Ä—å';
          dictStatus.className = 'status error';
        }
      };
      reader.onerror = () => {
        dictInfo.textContent = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥—ë–Ω.';
        dictStatus.textContent = '–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞';
        dictStatus.className = 'status error';
        dictErrors.textContent = '';
      };
      reader.readAsText(file, 'UTF-8');
    }

    function splitIntoFragments(text) {
      if (!text || typeof text !== 'string') return [];
      const minLength = minFragmentLength;
      const textLength = text.length;
      const fragments = [];
      let currentIndex = 0;

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      function isDigit(char) {
          return char >= '0' && char <= '9';
      }
      
      function isLowerCaseLetter(char) {
          return char >= 'a' && char <= 'z' || char >= '–∞' && char <= '—è';
      }
      
      function isUpperCaseLetter(char) {
          return char >= 'A' && char <= 'Z' || char >= '–ê' && char <= '–Ø';
      }

      while (currentIndex < textLength) {
          // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
          let fragmentEndIndex = currentIndex + minLength;
          
          // **–°–ª—É—á–∞–π 1: –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞**
          if (fragmentEndIndex > textLength) {
              const fragment = text.substring(currentIndex);
              if (fragment.trim()) fragments.push(fragment);
              break;
          }
          
          let foundBreak = false;
          let searchStart = fragmentEndIndex;
          
          // **–≠—Ç–∞–ø 1: –ü–æ–∏—Å–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –æ–∫–Ω–µ (mainFragmentLength —Å–∏–º–≤–æ–ª–æ–≤)**
          const mainSearchEnd = Math.min(searchStart + mainFragmentLength, textLength);
          
          // **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ —Å—Ç—Ä–æ–∫**
          for (let i = searchStart; i < mainSearchEnd; i++) {
              const char = text[i];
              if (char === '\n' || char === '\r' || char === '\v') {
                  fragmentEndIndex = i + 1;
                  foundBreak = true;
                  break;
              }
          }
          
          // **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Ñ–∏–≥—É—Ä–Ω–∞—è —Å–∫–æ–±–∫–∞**
          if (!foundBreak) {
              for (let i = searchStart; i < mainSearchEnd; i++) {
                  if (text[i] === '}') {
                      fragmentEndIndex = i + 1;
                      foundBreak = true;
                      break;
                  }
              }
          }
          
          // **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ö–æ–Ω–µ—Ü –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (. ! ?) —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**
          if (!foundBreak) {
              for (let i = searchStart; i < mainSearchEnd; i++) {
                  const char = text[i];
                  const nextChar = i + 1 < textLength ? text[i + 1] : '';
                  
                  if (char === '.') {
                      if (nextChar && (isDigit(nextChar) || isLowerCaseLetter(nextChar))) {
                          continue;
                      }
                      fragmentEndIndex = i + 1;
                      foundBreak = true;
                      break;
                  }
                  
                  if (char === '!' || char === '?') {
                      if (nextChar && (isLowerCaseLetter(nextChar) || nextChar === '(')) {
                          continue;
                      }
                      fragmentEndIndex = i + 1;
                      foundBreak = true;
                      break;
                  }
              }
          }
          
          // **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –¢–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π**
          if (!foundBreak) {
              for (let i = searchStart; i < mainSearchEnd; i++) {
                  if (text[i] === ';') {
                      fragmentEndIndex = i + 1;
                      foundBreak = true;
                      break;
                  }
              }
          }
          
          // **–≠—Ç–∞–ø 2: –ï—Å–ª–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –æ–∫–Ω–µ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –î–ê–õ–¨–®–ï –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô**
          if (!foundBreak) {
              const extendedSearchEnd = textLength;
              
              // **–ï–¥–∏–Ω—ã–π –ø–æ–∏—Å–∫ –≤—Å–µ—Ö 6 —Å–∏–º–≤–æ–ª–æ–≤: 3 —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è —Å—Ç—Ä–æ–∫ + 3 –∑–Ω–∞–∫–∞ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è**
              for (let i = mainSearchEnd; i < extendedSearchEnd; i++) {
                  const char = text[i];
                  if (char === '\n' || char === '\r' || char === '\v' || 
                      char === '.' || char === ',' || char === ';') {
                    fragmentEndIndex = i + 1;
                    foundBreak = true;
                    break;
                  }
              }
          }
          
          // **–ï—Å–ª–∏ —Ç–∞–∫ –∏ –Ω–µ –Ω–∞—à–ª–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (–æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ —Å–ª–æ–≤–æ/—á–∏—Å–ª–æ), –±–µ—Ä–µ–º –¥–æ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—Å—Ç–∞**
          if (!foundBreak) {
              fragmentEndIndex = textLength;
          }
          
          const fragment = text.substring(currentIndex, fragmentEndIndex);
          if (fragment.trim()) fragments.push(fragment);
          currentIndex = fragmentEndIndex;
      }
      
      return fragments;
    }

    function handleFileSelect(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let content = e.target.result;
          if (content.length > 10 * 1024 * 1024) {
            updateStatus('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 10 –º–µ–≥–∞–±–∞–π—Ç)', 'error');
            return;
          }
          const fileName = file.name.toLowerCase();
          if (fileName.endsWith('.html') || fileName.endsWith('.htm')) {
            content = extractTextFromHtml(content);
          }
          rawText = content;
          fragments = splitIntoFragments(rawText);
          
          const savedPosition = loadPositionForFile(file.name);
          currentFragmentIndex = savedPosition;
          
          startScreen.classList.add('hidden');
          mainInterface.classList.remove('hidden');
          textContent.classList.remove('hidden');
          textInput.classList.add('hidden');
          currentMode = 'file';
          updateTextDisplay();
          textContent.focus();
          
          let statusMsg = `–§–∞–π–ª "${file.name}" –∑–∞–≥—Ä—É–∂–µ–Ω. –§—Ä–∞–≥–º–µ–Ω—Ç–æ–≤: ${fragments.length}`;
          if (savedPosition > 0) {
            statusMsg += ` (–ø–æ–∑–∏—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: —Ñ—Ä–∞–≥–º–µ–Ω—Ç ${savedPosition + 1})`;
          }
          updateStatus(statusMsg);
          
        } catch (error) {
          updateStatus('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + error.message, 'error');
        }
      };
      reader.onerror = () => updateStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞', 'error');
      reader.readAsText(file, 'UTF-8');
    }

    function updateTextDisplay() {
      if (fragments.length === 0) return;
      textContent.replaceChildren();
      fragments.forEach((fragment, index) => {
        const isCurrent = index === currentFragmentIndex;
        const span = document.createElement('span');
        span.dataset.index = index;
        if (isCurrent) {
          span.className = 'current-fragment';
        }
        span.textContent = fragment;
        textContent.appendChild(span);
        textContent.appendChild(document.createTextNode(' '));
      });
      const currentElement = textContent.querySelector('.current-fragment');
      if (currentElement) {
        currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function getValidatedVoiceIndex() {
      let index = selectedVoiceIndex;
      if (index === null) {
        index = parseInt(voiceSelect.value, 10);
      }
      if (isNaN(index) || index < 0 || index >= voices.length || !voices[index]) {
        throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≥–æ–ª–æ—Å');
      }
      return index;
    }

    function speakCurrentFragment() {
      if (synth.speaking) {
        synth.cancel();
      }
      if (currentFragmentIndex >= fragments.length) {
        finalizePlayback('–¢–µ–∫—Å—Ç –∑–∞–∫–æ–Ω—á–∏–ª—Å—è');
        return;
      }
      let textToSpeak = fragments[currentFragmentIndex];
      if (replacementDict.size > 0) {
        textToSpeak = applyReplacements(textToSpeak);
      }
      try {
        const voiceIndex = getValidatedVoiceIndex();
        currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
        currentUtterance.voice = voices[voiceIndex];
        currentUtterance.rate = currentSpeed;
        currentUtterance.pitch = 1.0;
        currentUtterance.volume = currentVolume;
        
        currentUtterance.onstart = () => {
          updateTextDisplay();
        };
        currentUtterance.onend = () => {
          currentFragmentIndex++;
          if (currentFragmentIndex < fragments.length && isPlaying) {
            setTimeout(speakCurrentFragment, 100);
          } else {
            finalizePlayback('–û–∑–≤—É—á–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
          }
        };
        currentUtterance.onerror = (event) => {
          if (!event.error || ['interrupted', 'canceled', 'not-allowed'].includes(event.error)) {
            return;
          }
          finalizePlayback('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è', true);
        };
        synth.speak(currentUtterance);
      } catch (error) {
        finalizePlayback(error.message, true);
      }
    }

    function finalizePlayback(msg, isError = false) {
      isPlaying = false;
      playPauseBtn.textContent = '‚ñ∂';
      updateStatus(msg, isError ? 'error' : 'info');
    }

    function updateStatus(message, type = 'info') {
      statusContainer.textContent = message;
      statusContainer.className = `status ${type}`;
      
      if (!message || message.trim() === '') {
        statusContainer.classList.add('hidden');
      } else {
        statusContainer.classList.remove('hidden');
      }
      
      if (statusClearTimeout) {
        clearTimeout(statusClearTimeout);
        statusClearTimeout = null;
      }
      
      if (type !== 'error') {
        statusClearTimeout = setTimeout(() => {
          if (statusContainer.textContent === message) {
            statusContainer.textContent = '';
            statusContainer.className = 'status';
            statusContainer.classList.add('hidden');
          }
        }, CONFIG.STATUS_TIMEOUT);
      }
    }

    function updateSpeed() {
      speedValue.textContent = currentSpeed.toFixed(2) + 'x';
      speedDownBtn.disabled = currentSpeed <= CONFIG.MIN_SPEED;
      speedUpBtn.disabled = currentSpeed >= CONFIG.MAX_SPEED;
    }

    speedDownBtn.addEventListener('click', () => {
      if (currentSpeed > CONFIG.MIN_SPEED) {
        currentSpeed = Math.max(CONFIG.MIN_SPEED, currentSpeed - CONFIG.SPEED_STEP);
        updateSpeed();
        updateStatus(`–°–∫–æ—Ä–æ—Å—Ç—å: ${currentSpeed.toFixed(2)}x`, 'info');
      }
    });

    speedUpBtn.addEventListener('click', () => {
      if (currentSpeed < CONFIG.MAX_SPEED) {
        currentSpeed = Math.min(CONFIG.MAX_SPEED, currentSpeed + CONFIG.SPEED_STEP);
        updateSpeed();
        updateStatus(`–°–∫–æ—Ä–æ—Å—Ç—å: ${currentSpeed.toFixed(2)}x`, 'info');
      }
    });

    prevFragmentBtn.addEventListener('click', () => {
      currentFragmentIndex = Math.max(0, currentFragmentIndex - 1);
      updateTextDisplay();
      updateStatus(`–§—Ä–∞–≥–º–µ–Ω—Ç ${currentFragmentIndex + 1} –∏–∑ ${fragments.length}`);
      if (isPlaying) safeCancelAndSpeak();
    });

    nextFragmentBtn.addEventListener('click', () => {
      currentFragmentIndex = Math.min(fragments.length - 1, currentFragmentIndex + 1);
      updateTextDisplay();
      updateStatus(`–§—Ä–∞–≥–º–µ–Ω—Ç ${currentFragmentIndex + 1} –∏–∑ ${fragments.length}`);
      if (isPlaying) safeCancelAndSpeak();
    });

    function safeCancelAndSpeak() {
      if (isPlaying) {
        synth.cancel();
        speakCurrentFragment();
      }
    }

    playPauseBtn.addEventListener('click', () => {
      if (isPlaying) {
        synth.cancel();
        isPlaying = false;
        playPauseBtn.textContent = '‚ñ∂';
        updateStatus('–ü–∞—É–∑–∞');
      } else {
        if (currentMode === 'text') {
          rawText = textInput.value.trim();
          fragments = splitIntoFragments(rawText);
        }
        if (fragments.length === 0) {
          updateStatus('–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è', 'error');
          return;
        }
        if (currentFragmentIndex >= fragments.length) {
          currentFragmentIndex = 0;
        }
        isPlaying = true;
        playPauseBtn.textContent = '‚è∏';
        if (currentMode === 'text' && document.activeElement !== textInput) {
          textInput.classList.add('hidden');
          textContent.classList.remove('hidden');
          updateTextDisplay();
        }
        speakCurrentFragment();
      }
    });

    function loadVoicesForModal() {
      voices = synth.getVoices();
      voiceSelect.innerHTML = '';
      const lowerName = v => v.name.toLowerCase();
      const lowerURI = v => v.voiceURI.toLowerCase();
      const lang = v => v.lang || '';
      const isPiper = v => lowerName(v).includes('piper') || lowerURI(v).includes('piper');
      const isEdge = v => lowerName(v).includes('microsoft') || lowerURI(v).includes('microsoft');
      const isGoogle = v => lowerName(v).includes('google') || lowerURI(v).includes('google');
      const isMultilingual = v => lowerName(v).includes('multilingual');
      const isNatural = v => lowerName(v).includes('natural') || lowerName(v).includes('neural');
      const isRu = v => lang(v).startsWith('ru');
      const isEn = v => lang(v).startsWith('en');
      
      const browserLang = navigator.language || (navigator.languages && navigator.languages[0]) || 'en';
      const primaryLang = browserLang.substring(0, 2).toLowerCase();
      
      const groups = [
        { label: '–†—É—Å—Å–∫–∏–µ Piper', filter: v => isRu(v) && isPiper(v) },
        { label: '–û—Å—Ç–∞–ª—å–Ω—ã–µ Piper', filter: v => isPiper(v) && !(isRu(v) || isEn(v)) },
        { label: '–ê–Ω–≥–ª–∏–π—Å–∫–∏–µ Piper', filter: v => isEn(v) && isPiper(v) },
        { label: 'Multilingual (Edge)', filter: v => isEdge(v) && isMultilingual(v) },
        { label: '–†—É—Å—Å–∫–∏–µ Natural (Edge)', filter: v => isRu(v) && isEdge(v) && isNatural(v) },
        { label: '–†—É—Å—Å–∫–∏–µ Google', filter: v => isRu(v) && isGoogle(v) },
        { label: '–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä—É—Å—Å–∫–∏–µ', filter: v => isRu(v) && !isPiper(v) && !isEdge(v) && !isGoogle(v) },
      ];
      
      if (primaryLang !== 'ru') {
        const browserLangName = new Intl.DisplayNames(['ru'], { type: 'language' }).of(browserLang) || browserLang;
        groups.push({
          label: `${browserLangName.charAt(0).toUpperCase() + browserLangName.slice(1)} (${primaryLang})`,
          filter: v => lang(v).startsWith(primaryLang) && !isRu(v)
        });
      }
      
      groups.push(
        { label: '–ê–Ω–≥–ª–∏–π—Å–∫–∏–µ Natural (Edge)', filter: v => isEn(v) && isEdge(v) && isNatural(v) },
        { label: '–ê–Ω–≥–ª–∏–π—Å–∫–∏–µ Google', filter: v => isEn(v) && isGoogle(v) },
        { label: '–û—Å—Ç–∞–ª—å–Ω—ã–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ', filter: v => isEn(v) && !isPiper(v) && !isEdge(v) && !isGoogle(v) },
        { label: '–ü—Ä–æ—á–∏–µ –≥–æ–ª–æ—Å–∞', filter: v => !(isRu(v) || isEn(v) || (primaryLang !== 'ru' && lang(v).startsWith(primaryLang))) }
      );
      
      let total = 0;
      groups.forEach(group => {
        const filtered = voices.filter(group.filter);
        if (filtered.length > 0) {
          const optgroup = document.createElement('optgroup');
          optgroup.label = group.label;
          filtered.forEach(v => {
            const opt = document.createElement('option');
            opt.textContent = `${v.name} (${v.lang})`;
            opt.value = voices.indexOf(v);
            optgroup.appendChild(opt);
            total++;
          });
          voiceSelect.appendChild(optgroup);
        }
      });
      
      if (selectedVoiceIndex !== null && voices[selectedVoiceIndex]) {
        voiceSelect.value = selectedVoiceIndex;
      }
      voiceInfo.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ –≥–æ–ª–æ—Å–æ–≤: ${total}`;
    }

    voiceSelect.addEventListener('change', () => {
      selectedVoiceIndex = parseInt(voiceSelect.value, 10);
      saveAllSettings();
    });

    synth.addEventListener('voiceschanged', loadVoicesForModal);

    menuToggleBtn.addEventListener('click', showStartScreen);

    function showSettings() {
      startScreen.classList.add('hidden');
      mainInterface.classList.add('hidden');
      settingsScreen.classList.remove('hidden');
      
      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
      if (fragments.length > 0) {
        currentFragmentNumberInput.value = currentFragmentIndex + 1;
        fragmentRangeInfo.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤: ${fragments.length}`;
      } else {
        currentFragmentNumberInput.value = 1;
        fragmentRangeInfo.textContent = "–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞";
      }
      
      document.getElementById('applySettingsBtn').focus();
    }

    function hideSettings() {
      settingsScreen.classList.add('hidden');
      showStartScreen();
    }

    function applySettingsAndClose() {
      const input = document.getElementById('minFragmentLength');
      if (input && input.value !== '') {
        let value = Number(input.value);
        if (!isNaN(value)) {
          minFragmentLength = Math.max(10, Math.min(990, Math.floor(value / 10) * 10));
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—è "–î–ª–∏–Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞"
      const mainFragmentInput = document.getElementById('mainFragmentLength');
      if (mainFragmentInput && mainFragmentInput.value !== '') {
        let value = Number(mainFragmentInput.value);
        if (!isNaN(value)) {
          mainFragmentLength = Math.max(10, Math.min(990, Math.floor(value / 10) * 10));
        }
      }
      
      // –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—è "–ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞"
      const newNumber = parseInt(currentFragmentNumberInput.value);
      if (!isNaN(newNumber) && fragments.length > 0) {
        // –ü—Ä–æ—Å—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω
        let adjustedNumber = newNumber;
        if (adjustedNumber < 1) adjustedNumber = 1;
        if (adjustedNumber > fragments.length) adjustedNumber = fragments.length;
        
        const newIndex = adjustedNumber - 1;
        if (newIndex !== currentFragmentIndex) {
          currentFragmentIndex = newIndex;
          updateTextDisplay();
          updateStatus(`–ü–æ–∑–∏—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç ${currentFragmentIndex + 1}`, 'info');
          
          // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏
          if (isPlaying) {
            synth.cancel();
            isPlaying = false;
            playPauseBtn.textContent = '‚ñ∂';
          }
        }
      }
      
      saveAllSettings();
      updateStatus(`–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã: –º–∏–Ω.—Ñ—Ä–∞–≥–º–µ–Ω—Ç ‚Äî ${minFragmentLength}, –æ—Å–Ω.—á–∞—Å—Ç—å ‚Äî ${mainFragmentLength}`, 'info');
      hideSettings();
    }

    updateSpeed();
    initAccessibility();

    window.addEventListener('load', () => {
      loadAllSettings();
      const firstMenuItem = document.querySelector('.menu-item:not(.hidden)');
      if (firstMenuItem) firstMenuItem.focus();
    });

    document.addEventListener('DOMContentLoaded', () => {
      resumeTextBtn.addEventListener('click', resumeText);
      resumeTextBtn.addEventListener('keydown', (e) => handleMenuKeypress(e, resumeText));
      document.getElementById('menuInfo').addEventListener('click', showInfo);
      document.getElementById('menuInfo').addEventListener('keydown', (e) => handleMenuKeypress(e, showInfo));
      document.getElementById('menuVoice').addEventListener('click', showVoiceSelect);
      document.getElementById('menuVoice').addEventListener('keydown', (e) => handleMenuKeypress(e, showVoiceSelect));
      document.getElementById('menuOpenFile').addEventListener('click', openFile);
      document.getElementById('menuOpenFile').addEventListener('keydown', (e) => handleMenuKeypress(e, openFile));
      document.getElementById('menuTextInput').addEventListener('click', startTextInput);
      document.getElementById('menuTextInput').addEventListener('keydown', (e) => handleMenuKeypress(e, startTextInput));
      document.getElementById('menuLoadDict').addEventListener('click', loadDictionary);
      document.getElementById('menuLoadDict').addEventListener('keydown', (e) => handleMenuKeypress(e, loadDictionary));
      document.getElementById('menuSavePosition').addEventListener('click', savePositionManually);
      document.getElementById('menuSavePosition').addEventListener('keydown', (e) => handleMenuKeypress(e, savePositionManually));
      document.getElementById('menuSettings').addEventListener('click', showSettings);
      document.getElementById('menuSettings').addEventListener('keydown', (e) => handleMenuKeypress(e, showSettings));
      document.getElementById('menuExit').addEventListener('click', closeApp);
      document.getElementById('menuExit').addEventListener('keydown', (e) => handleMenuKeypress(e, closeApp));
      document.getElementById('fileInput').addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
      document.getElementById('dictInput').addEventListener('change', (e) => handleDictFile(e.target.files[0]));
      document.querySelectorAll('.close-btn').forEach(btn => {
        const modalId = btn.dataset.modal;
        const action = btn.dataset.action;
        if (modalId) {
          btn.addEventListener('click', () => closeModal(modalId));
        } else if (action === 'clearDictionary') {
          btn.addEventListener('click', clearDictionary);
        }
      });
      
      document.getElementById('applySettingsBtn').addEventListener('click', applySettingsAndClose);
      document.getElementById('cancelSettingsBtn').addEventListener('click', hideSettings);
      
      volumeSlider.addEventListener('input', (e) => {
        currentVolume = parseFloat(e.target.value);
        volumeValue.textContent = Math.round(currentVolume * 100) + '%';
        updateStatus(`–ì—Ä–æ–º–∫–æ—Å—Ç—å: ${Math.round(currentVolume * 100)}%`, 'info');
      });
      
      themeSelect.addEventListener('change', (e) => {
        document.documentElement.setAttribute('data-theme', e.target.value);
        saveAllSettings();
      });
      
      updateStatus('');
    });
  </script>
</body>
</html>